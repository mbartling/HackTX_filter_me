<!DOCTYPE html>
<html>
<head>
	<title>Filter Me</title>
	<style>
	body {
		background: rgba(150,150,150,1);
 		background: -webkit-linear-gradient(left, #444444, #999999, #444444);
		overflow:hidden;
		font-family:Tahoma;
		font-size:16pt;
	}
	.small {
		font-size:11pt;
	}
	a {
		text-decoration: none;
		font-weight:bold;
		color:blue;
	}
	#container {
		width: 98%;
		height: 600px;
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		margin: auto;
	}
	#bgSvg {
		position:absolute;
		top:0;
		left:0;
		background:yellow;
		width:100%;
		height:100%;
	}
	#preview0, #preview1 {
		position:absolute;
		top:0;
		left:0;
	}
	.animate {
    	-webkit-transform: translateZ(0);
		transition:left 1.2s ease-out;
	}
	.back {
		background:white;
		width:100%;
		height:100%;
		position:absolute;
		top:0;
		left:0;
		overflow:hidden;
	}
	.front {
		position:absolute;
		top:0;
		left:0;
		bottom:0;
		right:0;
		width:100%;
		height:150px;
		text-align:center;
		margin:auto;
	}
	#prompt1 {
		height:300px;
	}
	.box {
		border:1px solid black;
		height:400px;
		width:25%;
		position:absolute;
		top:10%;
	}
	.highlight {
		border:3px dashed red;
	}
	#box1 {
		left:37%;
	}
	#box2 {
		left:110%;
	}
	#box3 {
		left:143%;
	}
	#arrow, #equals {
		position:absolute;
		font-size:100pt;
		font-weight:bold;
		font-family:Arial;
	}
	#arrow {
		top:29%;
		left:104%;
	}
	#equals {
		top:31%;
		left:136.7%;
	}
	input[type='file'] {
		border:1px dashed #666666;
		border-radius:10px;
		padding:8px 12px;
	}
	/* gallery */
	table {
		border-spacing:0;
	}
	#galleryContainer {
		background:#C5E5F0;
		width:96%;
		border:1px solid #666666;
		border-collapse:collapse;
		position:relative;
	}
	.galleryButton {
		cursor:pointer;
		width:7%;
		background:#94C2D1;
		border:1px solid #666666;
	}
	#galleryRow td {
		width:12.5%;
		height:100px;
	}
	#galleryTable {
		width:400%;
		transform:translateX(0%);
		transition:transform 0.8s ease-in-out;
	}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript">
	/* animations */
	function moveElementLeft(elem,left) {
		elem.style.left = left;
	}
	function changeStage(stage) {
		var box1 = document.getElementById("box1");
		var box2 = document.getElementById("box2");
		var box3 = document.getElementById("box3");
		var arrow = document.getElementById("arrow");
		var equals = document.getElementById("equals");
		switch(stage) {
			case 0:
				moveElementLeft(box1,"37%");
				moveElementLeft(box2,"110%");
				moveElementLeft(box3,"143%");
				moveElementLeft(arrow,"104%");
				moveElementLeft(equals,"136.7%");
				break;
			case 1:
				moveElementLeft(box1,"20%");
				moveElementLeft(box2,"53%");
				moveElementLeft(box3,"143%");
				moveElementLeft(arrow,"47%");
				moveElementLeft(equals,"136.7%");
				break;
			case 2:
				moveElementLeft(box1,"4%");
				moveElementLeft(box2,"37%");
				moveElementLeft(box3,"70%");
				moveElementLeft(arrow,"31%");
				moveElementLeft(equals,"63.7%");
				startChecking();
				break;
		}
	}
	/* form */
	var droppedFiles = [null,null];
	function cancelEvent(e) {
		e.preventDefault();
		e.stopPropagation();
	}
	function fileDropped(e,n) {
		cancelEvent(e);
		$('#box'+(n+1)).removeClass("highlight");
		droppedFiles[n] = e.dataTransfer.files[0];
		submitted(e,n,true);
	}
	function draggedOver(e,n) {
		cancelEvent(e);
		$('#box'+(n+1)).addClass("highlight");
	}
	function draggedOut(e,n) {
		cancelEvent(e);
		$('#box'+(n+1)).removeClass("highlight");
	}
	function submitted(e,n,dropped) {
		w = document.getElementById("box"+(n+1)).offsetWidth;
		h = document.getElementById("box"+(n+1)).offsetHeight;
		if (e != null) e.preventDefault();
		var formData;
		if (dropped) {
			formData = new FormData();
			formData.append('file',droppedFiles[n]);
		} else {
			formData = new FormData(document.getElementById("upload"+n));
		}
		$.ajax({
			url: "/img"+(n+1),
			type: "POST",
			data: formData,
			contentType: false,
			cache: false,
			processData:false,
			success: function(data) {
						var wFactor = w/(Math.max(0,data.width));
						var hFactor = h/(Math.max(0,data.height));
						if (wFactor >= hFactor) {
							var newW = Math.round(data.width*wFactor);
							var newH = Math.round(data.height*wFactor);
							document.getElementById("preview"+n).style.top = ((newH-h)/(-2))+"px";
							document.getElementById("preview"+n).style.left = "0px";
						} else {
							var newW = Math.round(data.width*hFactor);
							var newH = Math.round(data.height*hFactor);
							document.getElementById("preview"+n).style.top = "0px";
							document.getElementById("preview"+n).style.left = ((newW-w)/(-2))+"px";
						}
						$(imgs[n]).attr({
							width:newW,
							height:newH,
							src:"/"+data['imgFolder']+data['imgName']
						});
					}
		});
	}
	var imgs = new Array();
	imgs[0] = new Image();
	imgs[1] = new Image();
	imgs[2] = new Image();
	$(document).ready(function(e) {
		document.body.addEventListener('touchstart', function(e){ e.preventDefault(); });
		//preview image
		$(imgs[0]).load(function(){
			$('#preview0').append($(this));
			document.getElementById("prompt0").style.display = "none";
			setTimeout(function(){changeStage(1);},600);
		});
		$(imgs[1]).load(function(){
			$('#preview1').append($(this));
			document.getElementById("prompt1").style.display = "none";
			setTimeout(function(){changeStage(2);},600);
		});
		$(imgs[2]).load(function(){
			$('#preview2').append($(this));
			document.getElementById("prompt2").style.display = "none";
		});
		//upload script
		$("#upload0").on('submit',(function(e) {
			submitted(e,0,false);
			return false;
		}));
		$("#upload1").on('submit',(function(e) {
			submitted(e,1,false);
			return false;
		}));
		//drag & drop
		document.getElementById("box1").addEventListener("drop",function(e){fileDropped(e,0);}, false);
		document.getElementById("box1").addEventListener("dragover",function(e){draggedOver(e,0);}, false);
		document.getElementById("box1").addEventListener("dragleave",function(e){draggedOut(e,0);}, false);
		document.getElementById("box2").addEventListener("drop",function(e){fileDropped(e,1);}, false);
		document.getElementById("box2").addEventListener("dragover",function(e){draggedOver(e,1);}, false);
		document.getElementById("box2").addEventListener("dragleave",function(e){draggedOut(e,1);}, false);
	});
	function reset() {
		imgs[0] = new Image();
		imgs[1] = new Image();
		imgs[2] = new Image();
		$(imgs[0]).load(function(){
			$('#preview0').append($(this));
			document.getElementById("prompt0").style.display = "none";
			setTimeout(function(){changeStage(1);},600);
		});
		$(imgs[1]).load(function(){
			$('#preview1').append($(this));
			document.getElementById("prompt1").style.display = "none";
			setTimeout(function(){changeStage(2);},600);
		});
		$(imgs[2]).load(function(){
			$('#preview2').append($(this));
			document.getElementById("prompt2").style.display = "none";
		});
		document.getElementById("preview0").innerHTML = "";
		document.getElementById("preview1").innerHTML = "";
		document.getElementById("preview2").innerHTML = "";
		document.getElementById("prompt0").style.display = "";
		document.getElementById("prompt1").style.display = "";
		document.getElementById("prompt2").style.display = "";
		droppedFiles = [null,null];
		document.getElementById("file0").value = "";
		document.getElementById("file1").value = "";
		changeStage(0);
	}
	var interval;
	function startChecking() {
		intervalCheck();
	}
	function intervalCheck() {
		$.ajax({
			url: "/img3",
			type: "POST",
			data: new FormData(), //blank
			contentType: false,
			cache: false,
			processData: false,
			success: function(data) {
						var wFactor = w/(Math.max(0,data.width));
						var hFactor = h/(Math.max(0,data.height));
						if (wFactor >= hFactor) {
							var newW = Math.round(data.width*wFactor);
							var newH = Math.round(data.height*wFactor);
							document.getElementById("preview2").style.top = ((newH-h)/(-2))+"px";
							document.getElementById("preview2").style.left = "0px";
						} else {
							var newW = Math.round(data.width*hFactor);
							var newH = Math.round(data.height*hFactor);
							document.getElementById("preview2").style.top = "0px";
							document.getElementById("preview2").style.left = ((newW-w)/(-2))+"px";
						}
						$(imgs[2]).attr({
							width:newW,
							height:newH,
							src:"/"+data['imgFolder']+data['imgName']
						});
					}
		});
	}
	/* gallery */
	var galleryOffset = 0;
	function galleryMove(dir) {
		galleryOffset -= dir*25;
		if (galleryOffset <= -100 || galleryOffset > 0) galleryOffset += dir*25;
		document.getElementById("galleryTable").style.transform = "translateX("+galleryOffset+"%)";
	}
	var presets = new Array();
	function init() {
		for (var i=1;i<=8;i++) {
			presets[i] = new Image();
			$(presets[i]).load(function(){
				$('#preset'+i).append($(this));
			});
			//get size data
			$.ajax({
				url: "/presetdata/"+i+".jpg",
				type: "POST",
				data: new FormData(), //blank
				contentType: false,
				cache: false,
				processData: false,
				success: function(data) {
							var w = document.getElementById("preset"+i).offsetWidth;
							var h = document.getElementById("preset"+i).offsetHeight;
							var wFactor = w/(Math.max(0,data.width));
							var hFactor = h/(Math.max(0,data.height));
							if (wFactor >= hFactor) {
								var newW = Math.round(data.width*wFactor);
								var newH = Math.round(data.height*wFactor);
							} else {
								var newW = Math.round(data.width*hFactor);
								var newH = Math.round(data.height*hFactor);
							}
							$(presets[i]).attr({
								width:newW,
								height:newH,
								src:"/presets/"+i+".jpg"
							});
						}
			});
		}
	}
	window.onload = init;
	</script>
</head>
<body>
	<div id="container">
		<div class="box animate" id="box3">
			<div class="back"><div id="preview2"></div></div>
			<div class="front" id="prompt2">
				Loading...
			</div>
		</div>
		<div class="animate" id="equals">
			=
		</div>
		<div class="box animate" id="box2">
			<div class="back"><div id="preview1"></div></div>
			<div class="front" id="prompt1">
				<form id="upload1" action="" method="post" enctype="multipart/form-data">
					<b>Now choose a picture for a filter.</b>
					<p class="small">Drag and drop a file into this box<br>or upload one below.</p>
					<p><input type="file" name="file" id="file1" autocomplete="off" onChange="submitted(null,1,false);"></p>
				</form>
				<p class="small">Or, choose one of our filters:</p>
				<table id="galleryContainer" align="center">
					<tr>
						<td onClick="galleryMove(-1);" class="galleryButton">
							&laquo;
						</td>
						<td style="width:86%;">
							<div style="width:100%;overflow:hidden;">
								<table id="galleryTable">
									<tr id="galleryRow">
										<td id="preset1" onClick="choosePreset(1);">
											
										</td>
										<td id="preset2" onClick="choosePreset(2);">
											
										</td>
										<td id="preset3" onClick="choosePreset(3);">
											
										</td>
										<td id="preset4" onClick="choosePreset(4);">
											
										</td>
										<td id="preset5" onClick="choosePreset(5);">
											
										</td>
										<td id="preset6" onClick="choosePreset(6);">
											
										</td>
										<td id="preset7" onClick="choosePreset(7);">
											
										</td>
										<td id="preset8" onClick="choosePreset(8);">
											
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td onClick="galleryMove(1);" class="galleryButton">
							&raquo;
						</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="animate" id="arrow">
			&raquo;
		</div>
		<div class="box animate" id="box1">
			<div class="back"><div id="preview0"></div></div>
			<div class="front" id="prompt0">
				<form id="upload0" action="" method="post" enctype="multipart/form-data">
					<b>First, pick a picture to be styled.</b>
					<p class="small">Drag and drop a file into this box<br>or upload one below.</p>
					<p><input type="file" name="file" id="file0" autocomplete="off" onChange="submitted(null,0,false);"></p>
				</form>
			</div>
		</div>
	</div>
</body>
</html>